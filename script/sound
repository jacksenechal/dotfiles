#!/usr/bin/env python3

import argparse
import subprocess
import sys
import json
import os
from pprint import pprint
from difflib import get_close_matches

def run_command(command):
    """Run a system command and return the output."""
    try:
        result = subprocess.run(command, stdout=subprocess.PIPE, text=True, check=True)
        return result.stdout
    except subprocess.CalledProcessError as e:
        print(f"An error occurred while running command: {' '.join(command)}")
        print(f"Error message: {e}")
        sys.exit(1)

def get_device_id(device_description, device_type):
    """Get the device ID for a given device description and type."""
    command = ['pactl', '--format', 'json', 'list', device_type]
    output = run_command(command)
    devices = json.loads(output)
    for device in devices:
        if device.get('description') == device_description:
            return device['name']
    return None

def get_device_description(device_name):
    """Get the device description for a given device name."""
    device_type = 'sources' if 'input' in device_name else 'sinks'
    command = ['pactl', '--format', 'json', 'list', device_type]
    output = run_command(command)
    devices = json.loads(output)
    for device in devices:
        if device['name'] == device_name:
            return device.get('description')
    return None

def find_fuzzy_match(target_description, device_type, cutoff=0.6):
    """Find a fuzzy match for a device description."""
    command = ['pactl', '--format', 'json', 'list', device_type]
    output = run_command(command)
    devices = json.loads(output)

    available_descriptions = [device.get('description') for device in devices if device.get('description')]

    matches = get_close_matches(target_description, available_descriptions, n=1, cutoff=cutoff)

    if matches:
        matched_description = matches[0]
        for device in devices:
            if device.get('description') == matched_description:
                return device['name'], matched_description
    return None, None

def update_device_in_config(config_path, device_name, input_description=None, output_description=None):
    """Update a device pair in the configuration file."""
    try:
        with open(config_path, 'r') as config_file:
            config = json.load(config_file)

        if device_name not in config:
            print(f"Device '{device_name}' not found in configuration.")
            return False

        if input_description:
            config[device_name]['input_device'] = input_description
        if output_description:
            config[device_name]['output_device'] = output_description

        with open(config_path, 'w') as config_file:
            json.dump(config, config_file, indent=4)

        return True
    except Exception as e:
        print(f"Error updating configuration: {e}")
        return False

def set_default_device(device_id, device_type):
    """Set the default device for the given device ID and type."""
    command = ['pactl', 'set-default-' + device_type, device_id]
    run_command(command)

def set_default_devices(input_device_id, output_device_id):
    """Set the default input and output devices."""
    set_default_device(input_device_id, 'source')
    set_default_device(output_device_id, 'sink')

def get_current_default_devices():
    """Get the current default input and output devices."""
    input_device = run_command(['pactl', 'get-default-source']).strip()
    output_device = run_command(['pactl', 'get-default-sink']).strip()
    return input_device, output_device

def add_device_pair_to_config(config_directory, config_path, device_name, input_device, output_device):
    """Add a new device pair to the configuration file."""
    if not os.path.exists(config_directory):
        os.makedirs(config_directory)
    if not os.path.isfile(config_path):
        with open(config_path, 'w') as config_file:
            json.dump({}, config_file, indent=4)

    input_description = get_device_description(input_device)
    output_description = get_device_description(output_device)

    with open(config_path, 'r+') as config_file:
        try:
            config = json.load(config_file)
            config[device_name] = {
                "input_device": input_description,
                "output_device": output_description
            }
            config_file.seek(0)
            json.dump(config, config_file, indent=4)
            config_file.truncate()
        except json.JSONDecodeError as e:
            print(f"Error parsing configuration file: {e}")
            sys.exit(1)

def display_config(config_path):
    """Display the contents of the configuration file in a readable format."""
    try:
        with open(config_path, 'r') as config_file:
            config = json.load(config_file)
            print("Sound Device Configurations:")
            print("----------------------------")
            for device_name, device_config in config.items():
                print(f"\nDevice Name: {device_name}")
                print(f"  Input Device:  {device_config['input_device']}")
                print(f"  Output Device: {device_config['output_device']}")
    except FileNotFoundError:
        print(f"Configuration file not found: {config_path}")
        sys.exit(1)
    except json.JSONDecodeError as e:
        print(f"Error parsing configuration file: {e}")
        sys.exit(1)

def remove_device_from_config(config_path, device_name):
    """Remove a device pair from the configuration file."""
    try:
        with open(config_path, 'r') as config_file:
            config = json.load(config_file)
        
        if device_name in config:
            del config[device_name]
            with open(config_path, 'w') as config_file:
                json.dump(config, config_file, indent=4)
            print(f"Device '{device_name}' has been removed from the configuration.")
        else:
            print(f"Device '{device_name}' not found in the configuration.")
    except FileNotFoundError:
        print(f"Configuration file not found: {config_path}")
        sys.exit(1)
    except json.JSONDecodeError as e:
        print(f"Error parsing configuration file: {e}")
        sys.exit(1)

def main():
    """Main function to set the default input and output devices based on the device name."""
    parser = argparse.ArgumentParser(description='Set the default input and output devices based on the device name.')
    parser.add_argument('device_name', help='The name of the device pair to set as default', nargs='?')
    parser.add_argument('-a', '--add', help='Add the currently selected default device pair to the config', type=str, metavar='device_name')
    parser.add_argument('-l', '--list', action='store_true', help='Display the contents of the configuration file')
    parser.add_argument('-r', '--remove', help='Remove a device pair from the configuration', type=str, metavar='device_name')
    args = parser.parse_args()

    config_directory = os.path.join(os.path.expanduser('~'), '.config')
    config_path = os.path.join(config_directory, 'sound_devices.json')

    if args.list:
        display_config(config_path)
        sys.exit(0)

    if args.remove:
        remove_device_from_config(config_path, args.remove)
        sys.exit(0)

    if not vars(args) or (not args.device_name and not args.add):
        parser.print_help()
        sys.exit(1)

    if args.add:
        device_name = args.add
        if device_name is None:
            print("Please provide a device name to add.")
            sys.exit(1)
        input_device, output_device = get_current_default_devices()
        add_device_pair_to_config(config_directory, config_path, device_name, input_device, output_device)
        print(f"Added current default devices as '{device_name}' to the configuration.")
        sys.exit(0)

    if args.device_name is None:
        parser.print_help()
        sys.exit(1)

    try:
        with open(config_path, 'r') as config_file:
            devices = json.load(config_file)
    except FileNotFoundError:
        print(f"Configuration file not found: {config_path}")
        sys.exit(1)
    except json.JSONDecodeError as e:
        print(f"Error parsing configuration file: {e}")
        sys.exit(1)

    device_name = args.device_name
    device_pair = devices.get(device_name)

    if not device_pair:
        print(f"Device pair not found: {device_name}")
        sys.exit(1)

    input_device_description = device_pair["input_device"]
    output_device_description = device_pair["output_device"]

    input_device_id = get_device_id(input_device_description, 'sources')
    output_device_id = get_device_id(output_device_description, 'sinks')

    config_updated = False

    # Handle fuzzy matching for input device if exact match fails
    if not input_device_id:
        print(f"\nExact match not found for input device: {input_device_description}")
        print("Attempting fuzzy match...")
        fuzzy_id, fuzzy_description = find_fuzzy_match(input_device_description, 'sources')

        if fuzzy_id and fuzzy_description:
            print(f"\nFound similar input device:")
            print(f"  Old: {input_device_description}")
            print(f"  New: {fuzzy_description}")
            response = input("Use this device and update config? (y/n): ").strip().lower()

            if response == 'y':
                input_device_id = fuzzy_id
                input_device_description = fuzzy_description
                config_updated = True
            else:
                print("Device selection cancelled.")
                sys.exit(1)
        else:
            print("No similar input device found.")
            sys.exit(1)

    # Handle fuzzy matching for output device if exact match fails
    if not output_device_id:
        print(f"\nExact match not found for output device: {output_device_description}")
        print("Attempting fuzzy match...")
        fuzzy_id, fuzzy_description = find_fuzzy_match(output_device_description, 'sinks')

        if fuzzy_id and fuzzy_description:
            print(f"\nFound similar output device:")
            print(f"  Old: {output_device_description}")
            print(f"  New: {fuzzy_description}")
            response = input("Use this device and update config? (y/n): ").strip().lower()

            if response == 'y':
                output_device_id = fuzzy_id
                output_device_description = fuzzy_description
                config_updated = True
            else:
                print("Device selection cancelled.")
                sys.exit(1)
        else:
            print("No similar output device found.")
            sys.exit(1)

    # Update config if fuzzy matches were accepted
    if config_updated:
        if update_device_in_config(config_path, device_name, input_device_description, output_device_description):
            print(f"Configuration updated for '{device_name}'")
        else:
            print("Warning: Failed to update configuration, but continuing with device selection.")

    set_default_devices(input_device_id, output_device_id)

    print(f"\nDefault input and output devices have been set to '{device_name}'")

if __name__ == '__main__':
    main()
